<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Memory Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.1/dist/chartjs-chart-treemap.min.js" crossorigin="anonymous"></script>
    <script>
    // Fallback: if CDN fails (e.g. pywebview offline), load from local static/
    if(typeof Chart==='undefined'){
        var s=document.createElement('script');
        s.src='/static/chart.umd.min.js';
        document.head.appendChild(s);
    }
    </script>
    <script>
    // Treemap plugin fallback
    document.addEventListener('DOMContentLoaded',()=>{
        if(typeof Chart!=='undefined' && !Chart.controllers.treemap){
            var s=document.createElement('script');
            s.src='/static/chartjs-chart-treemap.min.js';
            document.head.appendChild(s);
        }
    });
    </script>
    <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
        --bg:#f1f5e0; --bg-card:#fafcf2; --bg-sidebar:#f6f8ed; --bg-hover:#e8ecda;
        --bg-input:#f4f7e8; --bg-accent:#ede8fb;
        --text:#1a1530; --text-2:#4a4560; --text-3:#959f93;
        --primary:#3d15cb; --primary-h:#8e48ea; --primary-soft:#ede8fb;
        --success:#34a853; --success-soft:#e8f5e9;
        --warn:#e8a317;  --warn-soft:#fef6dd;
        --danger:#d93025; --danger-soft:#fce8e6;
        --border:#d4d9c8;
        --sh:0 1px 3px rgba(61,21,203,.06); --sh-lg:0 4px 16px rgba(61,21,203,.1);
        --r:10px; --r-sm:6px; --r-lg:14px;
        --sidebar-w:230px;
        --periwinkle:#9984d4;
        --chart-1:#3d15cb; --chart-2:#8e48ea; --chart-3:#9984d4; --chart-4:#959f93;
        --chart-5:#6b2ff5; --chart-6:#b8a9e3; --chart-7:#706b82; --chart-8:#c7cbc0;
    }
    [data-theme="dark"] {
        --bg:#0e0b1a; --bg-card:#16122a; --bg-sidebar:#110e22; --bg-hover:#1f1a36;
        --bg-input:#1a1530; --bg-accent:#241b45;
        --text:#f1f5e0; --text-2:#b8b3cc; --text-3:#706b82;
        --primary:#8e48ea; --primary-h:#9984d4; --primary-soft:#241b45;
        --success:#5be080; --success-soft:#0d3320;
        --warn:#fbbf24;  --warn-soft:#4a3506;
        --danger:#f87171; --danger-soft:#4a1515;
        --border:#2a2542;
        --periwinkle:#9984d4;
        --sh:0 1px 3px rgba(0,0,0,.35); --sh-lg:0 4px 16px rgba(142,72,234,.15);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
         background:var(--bg);color:var(--text);display:flex;height:100vh;overflow:hidden;
         transition:background .35s ease,color .35s ease;font-size:14px;line-height:1.5}
    a{text-decoration:none;color:inherit}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:var(--text-3)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SIDEBAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--bg-sidebar);
             border-right:1px solid var(--border);display:flex;flex-direction:column;
             transition:background .3s;user-select:none;z-index:10}
    .sidebar-logo{padding:1.25rem 1.25rem .75rem;display:flex;align-items:center;gap:.6rem}
    .logo-icon{font-size:1.6rem}
    .logo-text{font-size:1.1rem;font-weight:700;letter-spacing:-.02em}
    .sidebar-nav{flex:1;padding:.5rem .6rem;display:flex;flex-direction:column;gap:2px}
    .nav-item{display:flex;align-items:center;gap:.65rem;padding:.6rem .75rem;border-radius:var(--r-sm);
              cursor:pointer;font-weight:500;font-size:.875rem;color:var(--text-2);
              transition:all .2s ease;appearance:none;border:none;background:none;
              width:100%;text-align:left;font-family:inherit}
    .nav-item:hover{background:var(--bg-hover);color:var(--text)}
    .nav-item.active{background:var(--primary-soft);color:var(--primary);font-weight:600;
                     box-shadow:inset 3px 0 0 var(--primary)}
    .nav-item svg{width:18px;height:18px;flex-shrink:0;stroke-width:2}
    .nav-badge{margin-left:auto;font-size:.7rem;background:var(--primary);color:#fff;
               padding:1px 7px;border-radius:99px;font-weight:600}
    .sidebar-footer{padding:.75rem 1rem;border-top:1px solid var(--border);
                    display:flex;align-items:center;justify-content:space-between}
    .theme-btn{appearance:none;border:none;background:var(--bg-hover);color:var(--text-2);
               width:36px;height:36px;border-radius:var(--r-sm);cursor:pointer;
               display:flex;align-items:center;justify-content:center;transition:all .15s}
    .theme-btn:hover{background:var(--primary-soft);color:var(--primary)}
    .theme-btn svg{width:18px;height:18px}
    .sidebar-hint{font-size:.7rem;color:var(--text-3)}
    .sidebar-kbd{display:inline-flex;align-items:center;gap:2px;font-size:.65rem;
                 padding:2px 5px;background:var(--bg-hover);border:1px solid var(--border);
                 border-radius:4px;color:var(--text-3);font-family:inherit}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MAIN CONTENT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main{flex:1;overflow-y:auto;display:flex;flex-direction:column}
    .page{display:none;flex:1;padding:2rem 2.5rem 3rem;max-width:1200px;width:100%;
          margin:0 auto;animation:fadeUp .25s ease}
    .page.active{display:block}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .page-header{margin-bottom:1.75rem}
    .page-header h1{display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem}
    .page-header p{color:var(--text-3);font-size:.875rem}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);
          padding:1.5rem;box-shadow:var(--sh);transition:box-shadow .25s ease,border-color .25s ease,
          transform .25s ease}
    .card:hover{box-shadow:var(--sh-lg);transform:translateY(-1px)}
    .card+.card{margin-top:1rem}
    .card-title{font-size:.95rem;font-weight:600;margin-bottom:1rem;display:flex;
                align-items:center;gap:.5rem}
    .card-title svg{width:18px;height:18px;color:var(--primary)}
    .card-muted{color:var(--text-3);font-size:.8rem;margin-top:.5rem}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STAT CHIPS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .stats-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1.5rem}
    .stat-chip{display:flex;align-items:center;gap:.5rem;padding:.65rem 1rem;
               background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);
               min-width:150px;flex:1;transition:transform .2s ease,box-shadow .2s ease}
    .stat-chip .stat-icon{width:36px;height:36px;border-radius:var(--r-sm);display:flex;
                          align-items:center;justify-content:center;flex-shrink:0}
    .stat-chip .stat-icon.purple{background:var(--primary-soft);color:var(--primary)}
    .stat-chip .stat-icon.green{background:var(--success-soft);color:var(--success)}
    .stat-chip .stat-icon.amber{background:var(--warn-soft);color:var(--warn)}
    .stat-chip .stat-icon.red{background:var(--danger-soft);color:var(--danger)}
    .stat-chip .stat-info .stat-val{font-size:1.15rem;font-weight:700;line-height:1.2}
    .stat-chip .stat-info .stat-label{font-size:.7rem;color:var(--text-3);text-transform:uppercase;
                                       letter-spacing:.04em;font-weight:500}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem 1.1rem;
         border-radius:var(--r-sm);font-weight:600;font-size:.8rem;cursor:pointer;
         border:none;transition:all .2s cubic-bezier(.4,0,.2,1);font-family:inherit;white-space:nowrap}
    .btn svg{width:16px;height:16px}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-h);transform:translateY(-1px)}
    .btn-secondary{background:var(--bg-hover);color:var(--text-2);border:1px solid var(--border)}
    .btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{filter:brightness(1.1)}
    .btn-ghost{background:transparent;color:var(--text-2)}
    .btn-ghost:hover{background:var(--bg-hover)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{filter:brightness(1.15);transform:translateY(-1px)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
    .btn-icon{padding:.55rem;min-width:unset}
    .btn-lg{padding:.7rem 1.4rem;font-size:.875rem}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FORMS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .input{padding:.55rem .75rem;border:1px solid var(--border);border-radius:var(--r-sm);
           font-size:.875rem;font-family:inherit;background:var(--bg-input);color:var(--text);
           transition:border-color .15s,box-shadow .15s;width:100%;outline:none}
    .input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(61,21,203,.15)}
    .input::placeholder{color:var(--text-3)}
    textarea.input{resize:vertical;min-height:80px}
    .input-row{display:flex;gap:.5rem;align-items:center}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DROP ZONE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .drop-zone{border:2px dashed var(--border);border-radius:var(--r);padding:2rem;
               text-align:center;color:var(--text-3);cursor:pointer;transition:all .2s;
               margin-top:.75rem;appearance:none;background:none;width:100%;
               font-family:inherit;font-size:inherit}
    .drop-zone:hover,.drop-zone.drag-over{border-color:var(--primary);background:var(--primary-soft);
                                           color:var(--primary)}
    .drop-zone svg{width:32px;height:32px;margin:0 auto .5rem;display:block;opacity:.5}
    .drop-zone p{font-size:.85rem;margin-bottom:.25rem}
    .drop-zone small{font-size:.75rem;opacity:.7}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLOBAL PROGRESS BANNER  (visible on ALL pages)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .global-progress{display:none;background:var(--bg-card);border-bottom:1px solid var(--border);
        padding:.55rem 2rem;flex-shrink:0;cursor:pointer;user-select:none;
        transition:background .2s;appearance:none;border:none;width:100%;
        font-family:inherit;font-size:inherit;color:inherit;text-align:left}
    .global-progress:hover{background:var(--bg-hover)}
    .global-progress.visible{display:flex;align-items:center;gap:1rem;animation:fadeUp .25s ease}
    .global-progress.gp-done{cursor:default}
    .gp-track{flex:1;height:6px;background:var(--bg-hover);border-radius:99px;overflow:hidden;
        min-width:80px;max-width:420px}
    .gp-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-h));
        border-radius:99px;transition:width .35s ease;position:relative}
    .gp-fill.active::after{content:'';position:absolute;inset:0;
        background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
        animation:shimmer 1.5s infinite}
    .gp-text{font-size:.78rem;color:var(--text-2);white-space:nowrap;display:flex;
        align-items:center;gap:.5rem}
    .gp-pct{font-weight:700;color:var(--primary);min-width:2.5em;text-align:right}
    .gp-file{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
        font-family:monospace;font-size:.72rem;color:var(--text-3)}
    .gp-stats{font-size:.72rem;color:var(--text-3);display:flex;gap:.65rem}
    .gp-stats span{display:flex;align-items:center;gap:.2rem}
    .gp-dot{width:5px;height:5px;border-radius:50%;display:inline-block}

    /* Sidebar indexing badge */
    .nav-indexing-dot{width:8px;height:8px;border-radius:50%;background:var(--warn);
        margin-left:auto;animation:pulse-glow 1.5s ease infinite;display:none}
    .nav-indexing-dot.active{display:inline-block}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROGRESS (in-page detail section)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .progress-section{margin-top:1rem;display:none}
    .progress-section.visible{display:block;animation:fadeUp .3s ease}
    .progress-track{height:8px;background:var(--bg-hover);border-radius:99px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-h));
                   border-radius:99px;transition:width .3s ease;position:relative}
    .progress-fill.active::after{content:'';position:absolute;inset:0;
        background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);
        animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .progress-info{display:flex;justify-content:space-between;margin-top:.5rem;
                   font-size:.78rem;color:var(--text-3)}
    .progress-detail{font-size:.72rem;color:var(--text-3);margin-top:.35rem;
                     display:flex;justify-content:space-between;align-items:center}
    .progress-file{max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
                   color:var(--text-2);font-family:monospace;font-size:.7rem}
    .progress-stats{display:flex;gap:1rem;font-size:.72rem;margin-top:.5rem;flex-wrap:wrap}
    .progress-stats .ps{display:flex;align-items:center;gap:.25rem}
    .progress-stats .ps-dot{width:6px;height:6px;border-radius:50%;display:inline-block}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VOLUMES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .vol-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem;
              margin-top:.75rem}
    .vol-card{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);
              padding:.65rem .75rem;text-align:center;font-size:.78rem}
    .vol-letter{font-size:1rem;font-weight:700;color:var(--primary);margin-bottom:.3rem}
    .vol-bar{height:4px;background:var(--bg-hover);border-radius:2px;overflow:hidden;margin:.35rem 0}
    .vol-fill{height:100%;border-radius:2px;transition:width .3s}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BADGES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .badge{display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;
           border-radius:99px;font-size:.72rem;font-weight:600}
    .badge.green{background:var(--success-soft);color:var(--success)}
    .badge.amber{background:var(--warn-soft);color:var(--warn)}
    .badge.blue{background:var(--primary-soft);color:var(--primary)}
    .badge.red{background:var(--danger-soft);color:var(--danger)}
    .badge-row{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.75rem}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SEARCH PAGE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .search-box{position:relative}
    .search-box .search-icon{position:absolute;left:.85rem;top:50%;transform:translateY(-50%);
                              color:var(--text-3);width:18px;height:18px;pointer-events:none}
    .search-input{width:100%;padding:.85rem 1rem .85rem 2.75rem;font-size:1rem;
                  border:1.5px solid var(--border);border-radius:var(--r);background:var(--bg-input);
                  color:var(--text);outline:none;font-family:inherit;
                  transition:border-color .25s ease,box-shadow .25s ease}
    .search-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(61,21,203,.12)}
    .search-input::placeholder{color:var(--text-3)}
    .recent-tags{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.75rem}
    .recent-tag{font-size:.75rem;padding:.3rem .65rem;background:var(--bg-hover);
                border-radius:99px;cursor:pointer;color:var(--text-2);transition:all .15s;
                border:1px solid transparent;max-width:200px;overflow:hidden;text-overflow:ellipsis;
                white-space:nowrap}
    .recent-tag:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-soft)}
    .answer-card{margin-top:1.5rem;padding:1.25rem 1.5rem;background:var(--bg-card);
                 border:1px solid var(--border);border-left:4px solid var(--primary);
                 border-radius:var(--r);line-height:1.7;font-size:.9rem;white-space:pre-wrap;
                 box-shadow:var(--sh)}
    .sources-grid{display:grid;gap:.6rem;margin-top:1rem}
    .source-card{display:flex;align-items:flex-start;gap:.75rem;padding:.85rem 1rem;
                 background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);
                 transition:border-color .15s;cursor:default;animation:scale-in .25s ease both}
    .source-card:hover{border-color:var(--primary)}
    .source-num{width:24px;height:24px;background:var(--primary-soft);color:var(--primary);
                border-radius:50%;display:flex;align-items:center;justify-content:center;
                font-size:.7rem;font-weight:700;flex-shrink:0}
    .source-body{flex:1;min-width:0}
    .source-path{font-weight:600;font-size:.8rem;color:var(--primary);word-break:break-all}
    .source-text{font-size:.78rem;color:var(--text-3);margin-top:.3rem;
                 display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
                 cursor:pointer;transition:all .2s}
    .source-text.expanded{-webkit-line-clamp:unset;display:block}
    .source-expand-hint{font-size:.65rem;color:var(--primary);cursor:pointer;margin-top:.15rem;
                        display:inline-block;opacity:.7}
    .source-expand-hint:hover{opacity:1}
    .source-copy{appearance:none;border:none;background:none;color:var(--text-3);cursor:pointer;
                 padding:4px;border-radius:4px;transition:all .15s;flex-shrink:0}
    .source-copy:hover{color:var(--primary);background:var(--primary-soft)}
    .source-copy svg{width:14px;height:14px}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EXPLORER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .explorer-bar{display:flex;gap:.5rem;margin-bottom:1rem;align-items:center}
    .explorer-bar .input{max-width:280px}
    .folder-group{border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden;
                  margin-bottom:.5rem;background:var(--bg-card)}
    .folder-hdr{padding:.6rem .85rem;background:var(--bg-input);cursor:pointer;font-weight:600;
                font-size:.85rem;display:flex;justify-content:space-between;align-items:center;
                transition:background .15s;user-select:none}
    .folder-hdr:hover{background:var(--bg-hover)}
    .folder-hdr .arrow{transition:transform .25s cubic-bezier(.4,0,.2,1);color:var(--text-3)}
    .folder-hdr .arrow.open{transform:rotate(90deg)}
    .folder-files{display:none;border-top:1px solid var(--border)}
    .folder-files.open{display:block}
    .file-row{display:flex;justify-content:space-between;align-items:center;
              padding:.4rem .85rem .4rem 1.5rem;font-size:.8rem;transition:background .1s;
              border-bottom:1px solid var(--bg-hover)}
    .file-row:last-child{border-bottom:none}
    .file-row:hover{background:var(--bg-hover)}
    .file-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-right:.5rem;
               display:flex;align-items:center;gap:.4rem}
    .file-name .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .file-meta{color:var(--text-3);white-space:nowrap;font-size:.75rem}
    .empty-state{text-align:center;padding:3rem 1rem;color:var(--text-3)}
    .empty-state svg{width:48px;height:48px;margin:0 auto .75rem;opacity:.3}
    .empty-state p{font-size:.9rem;margin-bottom:.25rem}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INSIGHTS / CHARTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .charts-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
    .charts-row.full-width{grid-template-columns:1fr}
    @media(max-width:900px){.charts-row{grid-template-columns:1fr}}
    .chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);
                padding:1.25rem;box-shadow:var(--sh);display:flex;flex-direction:column;
                min-height:0;overflow:hidden;resize:vertical}
    .chart-card h3{font-size:.85rem;font-weight:600;margin-bottom:.75rem;color:var(--text-2);
                   display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .chart-card h3 .chart-legend{display:flex;gap:.5rem;flex-wrap:wrap;font-size:.7rem;font-weight:400}
    .chart-card h3 .legend-item{display:flex;align-items:center;gap:.25rem}
    .chart-card h3 .legend-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
    .chart-wrap{position:relative;flex:1;min-height:250px}
    .chart-wrap canvas{position:absolute;inset:0;width:100%!important;height:100%!important}
    table{width:100%;border-collapse:collapse;font-size:.8rem}
    th{text-align:left;padding:.55rem .75rem;background:var(--bg-input);color:var(--text-3);
       font-weight:600;font-size:.72rem;text-transform:uppercase;letter-spacing:.04em;
       border-bottom:1px solid var(--border)}
    td{padding:.55rem .75rem;border-bottom:1px solid var(--border)}
    tr:hover td{background:var(--bg-hover)}
    .table-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);
                overflow:hidden;box-shadow:var(--sh)}
    .table-card+.table-card{margin-top:1rem}
    .table-card h3{font-size:.85rem;font-weight:600;padding:1rem 1.25rem .5rem;color:var(--text-2)}
    .table-path{max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #toast-container{position:fixed;bottom:1.25rem;right:1.25rem;z-index:9999;
                     display:flex;flex-direction:column-reverse;gap:.5rem;pointer-events:none}
    .toast{display:flex;align-items:center;gap:.6rem;padding:.7rem 1rem;min-width:280px;
           background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);
           box-shadow:var(--sh-lg);font-size:.8rem;pointer-events:auto;
           animation:toastIn .3s cubic-bezier(.4,0,.2,1),toastOut .3s ease 3.7s forwards}
    .toast.success{border-left:3px solid var(--success)}
    .toast.error{border-left:3px solid var(--danger)}
    .toast.info{border-left:3px solid var(--primary)}
    .toast svg{width:16px;height:16px;flex-shrink:0}
    .toast.success svg{color:var(--success)}
    .toast.error svg{color:var(--danger)}
    .toast.info svg{color:var(--primary)}
    .toast span{flex:1}
    @keyframes toastIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
    @keyframes toastOut{to{opacity:0;transform:translateX(16px)}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COMMAND PALETTE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cmd-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:100;
                 align-items:flex-start;justify-content:center;padding-top:18vh;
                 backdrop-filter:blur(4px);animation:fadeIn .15s ease;border:none;padding:0;max-width:100vw;max-height:100vh;width:100vw;height:100vh}
    .cmd-overlay[open]{display:flex}
    .cmd-box{width:520px;background:var(--bg-card);border:1px solid var(--border);
             border-radius:var(--r-lg);box-shadow:var(--sh-lg);overflow:hidden}
    .cmd-box input{width:100%;padding:1rem 1.25rem;font-size:1rem;border:none;
                   background:transparent;color:var(--text);outline:none;font-family:inherit}
    .cmd-box input::placeholder{color:var(--text-3)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STATUS BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .status-bar{background:var(--bg-sidebar);border-top:1px solid var(--border);
                padding:.3rem 1.5rem;font-size:.7rem;color:var(--text-3);
                display:flex;justify-content:space-between;user-select:none;flex-shrink:0}
    .status-bar span{display:inline-flex;align-items:center;gap:.25rem}
    .status-dot{width:6px;height:6px;border-radius:50%;display:inline-block}
    .status-dot.green{background:var(--success)}
    .status-dot.amber{background:var(--warn);animation:pulse-glow 2s ease infinite}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING SKELETON
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .skeleton{background:linear-gradient(90deg,var(--bg-hover) 25%,var(--bg-input) 50%,var(--bg-hover) 75%);
              background-size:200% 100%;animation:skeleton 1.5s infinite;border-radius:var(--r-sm)}
    @keyframes skeleton{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton-line{height:14px;margin-bottom:.5rem;border-radius:4px}
    .skeleton-line:last-child{width:60%}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOW-OVERHEAD ANIMATIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @keyframes pulse-glow{0%,100%{box-shadow:0 0 0 0 rgba(61,21,203,.25)}50%{box-shadow:0 0 0 6px rgba(61,21,203,0)}}
    @keyframes slide-in-left{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:none}}
    @keyframes scale-in{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:none}}
    .sidebar-nav .nav-item:nth-child(1){animation:slide-in-left .3s ease .05s both}
    .sidebar-nav .nav-item:nth-child(2){animation:slide-in-left .3s ease .1s both}
    .sidebar-nav .nav-item:nth-child(3){animation:slide-in-left .3s ease .15s both}
    .sidebar-nav .nav-item:nth-child(4){animation:slide-in-left .3s ease .2s both}
    .sidebar-nav .nav-item:nth-child(5){animation:slide-in-left .3s ease .25s both}
    .stat-chip:hover{transform:translateY(-2px);box-shadow:var(--sh-lg)}
    .btn-primary:hover,.btn-danger:hover{transform:translateY(-1px);
        box-shadow:0 4px 12px rgba(61,21,203,.2)}
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar">
    <div class="sidebar-logo">
        <span class="logo-icon">ğŸ§ </span>
        <span class="logo-text">PMA</span>
    </div>

    <nav class="sidebar-nav">
        <button class="nav-item active" onclick="switchPage('library',this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
            <span>Library</span>
            <span class="nav-indexing-dot" id="nav-indexing-dot" title="Indexing in progress..."></span>
        </button>
        <button class="nav-item" onclick="switchPage('search',this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <span>Search</span>
            <span class="sidebar-kbd">Ctrl+K</span>
        </button>
        <button class="nav-item" onclick="switchPage('explorer',this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
            <span>Explorer</span>
        </button>
        <button class="nav-item" onclick="switchPage('insights',this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
            <span>Insights</span>
        </button>
    </nav>

    <div class="sidebar-footer">
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle dark/light theme">
            <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
            </svg>
        </button>
        <span class="sidebar-hint">v1.0</span>
    </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN CONTENT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">

<!-- Global progress banner (visible on all pages) -->
<button class="global-progress" id="global-progress" onclick="switchPage('library')" aria-label="View indexing progress">
    <div class="gp-text">
        <span class="gp-pct" id="gp-pct">0%</span>
        <span id="gp-label">Indexing...</span>
    </div>
    <div class="gp-track"><div class="gp-fill active" id="gp-fill" style="width:0%"></div></div>
    <span class="gp-file" id="gp-file"></span>
    <div class="gp-stats">
        <span><span class="gp-dot" style="background:var(--success)"></span> <span id="gp-new">0</span></span>
        <span><span class="gp-dot" style="background:var(--warn)"></span> <span id="gp-changed">0</span></span>
        <span><span class="gp-dot" style="background:var(--text-3)"></span> <span id="gp-skipped">0</span></span>
    </div>
</button>

<!-- --- LIBRARY PAGE --- -->
<div class="page active" id="page-library">
    <div class="page-header">
        <h1>ğŸ“š Library</h1>
        <p>Index folders and files into your personal memory</p>
    </div>

    <!-- Quick stats -->
    <div class="stats-row" id="lib-stats">
        <div class="stat-chip">
            <div class="stat-icon purple">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="s-files">0</div><div class="stat-label">Files</div></div>
        </div>
        <div class="stat-chip">
            <div class="stat-icon green">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="s-chunks">0</div><div class="stat-label">Chunks</div></div>
        </div>
        <div class="stat-chip">
            <div class="stat-icon amber">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="s-scan">â€”</div><div class="stat-label">Scan Mode</div></div>
        </div>
    </div>

    <!-- Add to Memory card -->
    <div class="card">
        <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
            Add to Memory
        </div>

        <div style="display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="pickFolder()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
                Select Folder
            </button>
            <button class="btn btn-secondary" onclick="pickFiles()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
                Select Files
            </button>
        </div>

        <div class="input-row">
            <input type="text" id="folders-input" class="input" placeholder="Or paste paths (comma-separated)  e.g. C:\Users\Name\Documents" aria-label="Folder paths to index">
            <button class="btn btn-success btn-lg" id="index-btn" onclick="startIndexing()" aria-label="Start indexing folders">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0018 9h-1.26A8 8 0 103 16.3"/></svg>
                Index
            </button>
        </div>

        <!-- Drop zone -->
        <button class="drop-zone" id="drop-zone" onclick="pickFolder()" aria-label="Select folder to index">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <p>Click to browse or drag folders here</p>
            <small>Supported: .txt, .md, .py, .js, .pdf and more</small>
        </button>

        <!-- Progress -->
        <div class="progress-section" id="progress-section">
            <div class="progress-track"><div class="progress-fill active" id="progress-fill" style="width:0%"></div></div>
            <div class="progress-info">
                <span id="progress-label">Indexing...</span>
                <span id="progress-pct">0%</span>
            </div>
            <div class="progress-detail">
                <span class="progress-file" id="progress-file" title=""></span>
                <span id="progress-count">0 / 0 files</span>
            </div>
            <div class="progress-stats">
                <span class="ps"><span class="ps-dot" style="background:var(--success)"></span> New: <strong id="ps-new">0</strong></span>
                <span class="ps"><span class="ps-dot" style="background:var(--warn)"></span> Changed: <strong id="ps-changed">0</strong></span>
                <span class="ps"><span class="ps-dot" style="background:var(--text-3)"></span> Skipped: <strong id="ps-skipped">0</strong></span>
                <span class="ps"><span class="ps-dot" style="background:var(--primary)"></span> Chunks: <strong id="ps-chunks">0</strong></span>
            </div>
        </div>
    </div>

    <!-- System info card -->
    <div class="card" id="sys-card" style="display:none">
        <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            System
        </div>
        <div class="badge-row" id="sys-badges"></div>
        <div class="vol-grid" id="vol-grid"></div>
    </div>

    <!-- Quick start -->
    <div class="card">
        <div class="card-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Quick Start
        </div>
        <p style="font-size:.85rem;color:var(--text-2);margin-bottom:.75rem">Load sample documents to test the system instantly.</p>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-secondary" id="seed-btn" onclick="seedDemo()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
            Seed Demo Data
        </button>
        <button class="btn btn-ghost" onclick="cleanupStale()" title="Remove entries for deleted files">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            Cleanup Stale
        </button>
        <button class="btn btn-ghost" onclick="exportIndex()" title="Export index as JSON">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export
        </button>
        <button class="btn btn-danger" onclick="clearDatabase()" title="Permanently erase all indexed data">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            Clear Database
        </button>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ SEARCH PAGE â”€â”€â”€ -->
<div class="page" id="page-search">
    <div class="page-header">
        <h1>ğŸ” Search</h1>
        <p>Ask questions about your indexed files â€” powered by RAG</p>
    </div>

    <div class="card">
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <input type="text" class="search-input" id="search-input" placeholder="Ask anything about your files..." autocomplete="off" aria-label="Search your indexed files">
        </div>
        <div class="recent-tags" id="recent-tags"></div>
        <div style="margin-top:.75rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
            <button class="btn btn-primary btn-lg" id="ask-btn" onclick="askQuestion()" aria-label="Ask Question">
                Ask Question
            </button>
            <select class="input" id="filter-type" style="width:auto;min-width:100px;padding:.45rem .65rem;font-size:.78rem" aria-label="Filter by file type">
                <option value="">All types</option>
                <option value=".txt">.txt</option>
                <option value=".md">.md</option>
                <option value=".pdf">.pdf</option>
                <option value=".py">.py</option>
                <option value=".js">.js</option>
                <option value=".docx">.docx</option>
                <option value=".json">.json</option>
                <option value=".csv">.csv</option>
            </select>
            <span style="font-size:.72rem;color:var(--text-3)">Press Enter to search</span>
        </div>
    </div>

    <div id="results-area" style="display:none">
        <div style="margin-top:1.5rem">
            <h2 style="display:flex;align-items:center;gap:.5rem">Answer <span id="latency-badge" class="badge blue" style="font-size:.65rem;display:none"></span></h2>
            <div class="answer-card" id="answer-text"></div>
        </div>
        <div style="margin-top:1.25rem">
            <h2>Sources <span id="source-count" style="font-size:.72rem;color:var(--text-3)"></span></h2>
            <div class="sources-grid" id="sources-list"></div>
        </div>
    </div>
</div>

<!-- â”€â”€â”€ EXPLORER PAGE â”€â”€â”€ -->
<div class="page" id="page-explorer">
    <div class="page-header">
        <h1>ğŸ“‚ Explorer</h1>
        <p id="explorer-summary">Browse your indexed files</p>
    </div>

    <div class="explorer-bar">
        <input type="text" class="input" id="explorer-filter" placeholder="Filter files..." oninput="debouncedFilterTree(this.value)" aria-label="Filter indexed files">
        <button class="btn btn-secondary btn-icon" onclick="fetchFileTree()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
        </button>
    </div>

    <div id="file-tree"></div>
</div>

<!-- â”€â”€â”€ INSIGHTS PAGE â”€â”€â”€ -->
<div class="page" id="page-insights">
    <div class="page-header">
        <h1>ğŸ“Š Insights</h1>
        <p>Visualize your personal memory at a glance</p>
    </div>

    <div class="stats-row">
        <div class="stat-chip">
            <div class="stat-icon purple">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="i-files">0</div><div class="stat-label">Files</div></div>
        </div>
        <div class="stat-chip">
            <div class="stat-icon green">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="i-size">0 MB</div><div class="stat-label">Storage</div></div>
        </div>
        <div class="stat-chip">
            <div class="stat-icon amber">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="i-chunks">0</div><div class="stat-label">Chunks</div></div>
        </div>
        <div class="stat-chip">
            <div class="stat-icon red">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 11-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
            </div>
            <div class="stat-info"><div class="stat-val" id="i-cold">0</div><div class="stat-label">Cold Files</div></div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-row full-width">
        <div class="chart-card" style="min-height:380px">
            <h3><span>File Type Distribution (by size)</span><span class="chart-legend" id="type-chart-legend"></span></h3>
            <div class="chart-wrap"><canvas id="type-chart"></canvas></div>
        </div>
    </div>
    <div class="charts-row full-width">
        <div class="chart-card" style="min-height:340px">
            <h3><span>Storage by Folder</span><span class="chart-legend" id="folder-chart-legend"></span></h3>
            <div class="chart-wrap"><canvas id="folder-chart"></canvas></div>
        </div>
    </div>

    <!-- Tables -->
    <div class="table-card">
        <h3>Largest Files</h3>
        <table><thead><tr><th>Path</th><th style="width:100px;text-align:right">Size</th></tr></thead>
        <tbody id="top-files-body"></tbody></table>
    </div>
    <div class="table-card">
        <h3>Cold Files â€” Never Referenced</h3>
        <table><thead><tr><th>Path</th><th style="width:100px;text-align:right">Size</th></tr></thead>
        <tbody id="cold-files-body"></tbody></table>
    </div>
</div>

<!-- Status bar -->
<div class="status-bar">
    <span><span class="status-dot green" id="status-dot"></span> <span id="sb-status">Ready</span></span>
    <span id="sb-scan">Scan: â€”</span>
    <span id="sb-files">Files: 0</span>
    <span id="sb-chunks">Chunks: 0</span>
</div>

</div><!-- /main -->

<!-- Toast container -->
<div id="toast-container"></div>

<!-- Command palette -->
<dialog id="cmd-overlay" class="cmd-overlay" aria-label="Command palette">
    <div class="cmd-box">
        <input type="text" id="cmd-input" placeholder="Search your memory..." onkeydown="if(event.key==='Enter'){event.preventDefault();runCmdSearch()}" onkeyup="if(event.key==='Escape')closeCmdPalette()">
    </div>
</dialog>

<script type="module">
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(bytes){
    if(!bytes||bytes===0)return '0 B';
    const k=1024,u=['B','KB','MB','GB','TB'];
    const i=Math.floor(Math.log(bytes)/Math.log(k));
    return Number.parseFloat((bytes/Math.pow(k,i)).toFixed(1))+' '+u[i];
}

const EXT_COLORS = {'.py':'#3572A5','.js':'#f1e05a','.ts':'#3178c6','.md':'#083fa1',
    '.txt':'#6b7280','.json':'#292929','.html':'#e34c26','.css':'#563d7c',
    '.pdf':'#e11d48','.java':'#b07219','.c':'#555555','.cpp':'#f34b7d','.rs':'#dea584'};
function extColor(name){
    const ext='.'+name.split('.').pop().toLowerCase();
    return EXT_COLORS[ext]||'var(--text-3)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST NOTIFICATIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg,type='info'){
    const c=document.getElementById('toast-container');
    const iconPaths={
        success:'<polyline points="20 6 9 17 4 12"/>',
        error:'<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',
        info:'<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>'
    };
    const el=document.createElement('div');
    el.className='toast '+type;
    // Use DOM methods instead of innerHTML to prevent XSS
    const svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox','0 0 24 24');svg.setAttribute('fill','none');
    svg.setAttribute('stroke','currentColor');svg.setAttribute('stroke-width','2');
    svg.setAttribute('stroke-linecap','round');svg.setAttribute('stroke-linejoin','round');
    svg.innerHTML=iconPaths[type]||iconPaths.info;
    const span=document.createElement('span');
    span.textContent=msg;
    el.appendChild(svg);el.appendChild(span);
    c.appendChild(el);
    setTimeout(()=>el.remove(),4200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchPage(id,el){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('page-'+id).classList.add('active');
    if(el)el.classList.add('active');
    else document.querySelector(`.nav-item[onclick*="${id}"]`)?.classList.add('active');

    // Always refresh data when switching pages
    if(id==='explorer')fetchFileTree();
    if(id==='insights')fetchInsights();
    if(id==='library')fetchStatus();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleTheme(){
    const html=document.documentElement;
    const next=html.dataset.theme==='dark'?'light':'dark';
    html.dataset.theme=next;
    localStorage.setItem('pma-theme',next);
    updateThemeIcon(next);
    // Update charts if they exist
    if(globalThis._typeChart)updateChartTheme();
}
function updateThemeIcon(theme){
    const icon=document.getElementById('theme-icon');
    icon.innerHTML = theme==='dark'
        ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
        : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
}
(function initTheme(){
    const saved=localStorage.getItem('pma-theme');
    if(saved){document.documentElement.dataset.theme=saved;updateThemeIcon(saved);}
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE / FOLDER PICKER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function pickFolder(){
    try{
        const res=await fetch('/pick/folder');
        const data=await res.json();
        if(data.path){
            const input=document.getElementById('folders-input');
            input.value=input.value?(input.value+', '+data.path):data.path;
            toast('Folder selected: '+data.path.split(/[/\\]/).pop(),'success');
        }
    }catch(e){console.error('Folder picker failed',e);toast('Could not open folder picker','error');}
}

async function pickFiles(){
    try{
        const res=await fetch('/pick/file');
        const data=await res.json();
        if(data.paths&&data.paths.length){
            const input=document.getElementById('folders-input');
            // Extract parent folders from selected files
            const folders=[...new Set(data.paths.map(p=>{
                const sep=p.includes('/')?'/':'\\';
                return p.substring(0,p.lastIndexOf(sep));
            }))];
            const val=folders.join(', ');
            input.value=input.value?(input.value+', '+val):val;
            toast(data.paths.length+' file(s) selected','success');
        }
    }catch(e){console.error('File picker failed',e);toast('Could not open file picker','error');}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function initDrop(){
    const zone=document.getElementById('drop-zone');
    if(!zone)return;
    ['dragenter','dragover'].forEach(e=>zone.addEventListener(e,ev=>{ev.preventDefault();zone.classList.add('drag-over');}));
    ['dragleave','drop'].forEach(e=>zone.addEventListener(e,ev=>{ev.preventDefault();zone.classList.remove('drag-over');}));
    zone.addEventListener('drop',ev=>{
        const items=ev.dataTransfer.files;
        if(!items.length)return;
        // In desktop (pywebview/Electron) we can get paths
        const paths=[];
        for(const f of items){
            if(f.path) paths.push(f.path);
            else if(f.name) paths.push(f.name);
        }
        if(paths.length){
            // Get parent folders
            const folders=[...new Set(paths.map(p=>{
                const sep=p.includes('/')?'/':'\\';
                const idx=p.lastIndexOf(sep);
                return idx>0?p.substring(0,idx):p;
            }))];
            const input=document.getElementById('folders-input');
            input.value=input.value?(input.value+', '+folders.join(', ')):folders.join(', ');
            toast(folders.length+' path(s) added','success');
        }
    });
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INDEXING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startIndexing(){
    const input=document.getElementById('folders-input').value;
    const folders=input.split(',').map(f=>f.trim().replace(/^["'](.+)["']$/,'$1')).filter(Boolean);
    if(!folders.length){toast('Enter at least one folder path','error');return;}

    const btn=document.getElementById('index-btn');
    btn.disabled=true;

    try{
        const res=await fetch('/index/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({folders})});
        if(!res.ok){const d=await res.json();toast(d.error||'Indexing failed','error');btn.disabled=false;return;}
        toast('Indexing started','success');
        
        // Show progress bars immediately
        document.getElementById('global-progress').classList.add('visible');
        document.getElementById('global-progress').classList.remove('gp-done');
        document.getElementById('gp-label').textContent='Starting index...';
        document.getElementById('progress-section').classList.add('visible');
        document.getElementById('progress-label').textContent='Starting...';
        document.getElementById('nav-indexing-dot').classList.add('active');
        
        startProgressStream();
    }catch(e){console.error('Indexing start failed',e);toast('Failed to start indexing','error');btn.disabled=false;}
}

async function seedDemo(){
    const btn=document.getElementById('seed-btn');
    btn.disabled=true;
    try{
        const res=await fetch('/demo/seed',{method:'POST'});
        const data=await res.json();
        toast(data.message,'success');
        document.getElementById('folders-input').value=data.folder;
        
        // Show progress bars immediately
        document.getElementById('global-progress').classList.add('visible');
        document.getElementById('global-progress').classList.remove('gp-done');
        document.getElementById('gp-label').textContent='Starting demo index...';
        document.getElementById('progress-section').classList.add('visible');
        document.getElementById('progress-label').textContent='Starting...';
        document.getElementById('nav-indexing-dot').classList.add('active');
        
        startProgressStream();
    }catch(e){console.error('Demo seed failed',e);toast('Failed to seed demo data','error');}
    finally{btn.disabled=false;}
}

async function cleanupStale(){
    try{
        const res=await fetch('/index/cleanup',{method:'POST'});
        const data=await res.json();
        if(!res.ok){toast(data.error||'Cleanup failed','error');return;}
        toast(`Cleanup done â€” ${data.removed_count} stale entries removed`,'success');
        fetchStatus();
    }catch(e){console.error('Cleanup failed',e);toast('Cleanup request failed','error');}
}

async function exportIndex(){
    try{
        const res=await fetch('/index/export');
        const data=await res.json();
        const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download='pma-index-export.json';a.click();
        URL.revokeObjectURL(url);
        toast('Index exported','success');
    }catch(e){console.error('Export failed',e);toast('Export failed','error');}
}

async function clearDatabase(){
    if(!confirm('âš ï¸ CLEAR DATABASE\n\nThis will permanently delete ALL indexed files, chunks, embeddings, and query history.\n\nThis action cannot be undone. Continue?'))return;
    if(!confirm('Are you absolutely sure? Type OK to confirm this destructive action.'))return;
    try{
        const res=await fetch('/index/clear',{method:'POST'});
        const data=await res.json();
        if(!res.ok){toast(data.error||'Clear failed','error');return;}
        toast(`Database cleared â€” ${data.files_removed} files, ${data.chunks_removed} chunks removed`,'success');
        // Reset UI counters
        document.getElementById('s-files').textContent='0';
        document.getElementById('s-chunks').textContent='0';
        document.getElementById('sb-files').textContent='Files: 0';
        document.getElementById('sb-chunks').textContent='Chunks: 0';
        fetchStatus();
    }catch(e){console.error('Clear DB failed',e);toast('Clear database request failed','error');}
}

/* â”€â”€ SSE real-time progress stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _evtSource=null;
function startProgressStream(){
    // Close any existing connection
    if(_evtSource){_evtSource.close();_evtSource=null;}
    _evtSource=new EventSource('/index/progress-stream');
    _evtSource.addEventListener('progress',e=>{
        try{const d=JSON.parse(e.data);updateProgress(d);}catch(err){console.debug('progress parse error',err);}
    });
    _evtSource.onerror=()=>{
        _evtSource.close();_evtSource=null;
        // Fallback: fetch final status
        setTimeout(fetchStatus,1000);
    };
}

function _getProgressElements(){
    return {
        section: document.getElementById('progress-section'),
        fill: document.getElementById('progress-fill'),
        labelEl: document.getElementById('progress-label'),
        pctEl: document.getElementById('progress-pct'),
        indexBtn: document.getElementById('index-btn'),
        dot: document.getElementById('status-dot'),
        fileEl: document.getElementById('progress-file'),
        countEl: document.getElementById('progress-count'),
        psNew: document.getElementById('ps-new'),
        psChanged: document.getElementById('ps-changed'),
        psSkipped: document.getElementById('ps-skipped'),
        psChunks: document.getElementById('ps-chunks'),
        gp: document.getElementById('global-progress'),
        gpFill: document.getElementById('gp-fill'),
        gpPct: document.getElementById('gp-pct'),
        gpLabel: document.getElementById('gp-label'),
        gpFile: document.getElementById('gp-file'),
        gpNew: document.getElementById('gp-new'),
        gpChanged: document.getElementById('gp-changed'),
        gpSkipped: document.getElementById('gp-skipped'),
        navDot: document.getElementById('nav-indexing-dot')
    };
}

function _shortFileName(fullPath){
    return fullPath?fullPath.split(/[/\\]/).pop():'';
}

function _updateRunningState(d,els){
    els.section.classList.add('visible');
    els.fill.style.width=d.progress_percent+'%';
    els.fill.classList.add('active');
    els.labelEl.textContent=`Indexing -- ${d.new_files||0} new, ${d.changed_files||0} changed, ${d.skipped_files||0} skipped`;
    els.pctEl.textContent=d.progress_percent+'%';
    els.indexBtn.disabled=true;
    els.dot.className='status-dot amber';
    document.getElementById('sb-status').textContent='Indexing...';

    if(els.fileEl&&d.current_file){
        const short=_shortFileName(d.current_file);
        els.fileEl.textContent=short;els.fileEl.title=d.current_file;
    }
    if(els.countEl)els.countEl.textContent=`${d.processed_files||0} / ${d.total_files||0} files`;
    if(els.psNew)els.psNew.textContent=d.new_files||0;
    if(els.psChanged)els.psChanged.textContent=d.changed_files||0;
    if(els.psSkipped)els.psSkipped.textContent=d.skipped_files||0;
    if(els.psChunks)els.psChunks.textContent=d.total_chunks||0;

    els.gp.classList.add('visible');
    els.gp.classList.remove('gp-done');
    els.gpFill.style.width=d.progress_percent+'%';
    els.gpFill.classList.add('active');
    els.gpPct.textContent=d.progress_percent+'%';
    els.gpLabel.textContent=`Indexing ${d.processed_files||0} / ${d.total_files||0} files`;
    if(d.current_file){
        const short=_shortFileName(d.current_file);
        els.gpFile.textContent=short;els.gpFile.title=d.current_file;
    }
    els.gpNew.textContent=d.new_files||0;
    els.gpChanged.textContent=d.changed_files||0;
    els.gpSkipped.textContent=d.skipped_files||0;
    els.navDot.classList.add('active');
}

function _updateCompleteState(d,els){
    els.fill.classList.remove('active');
    els.fill.style.width='100%';
    els.indexBtn.disabled=false;
    if(els.section.classList.contains('visible')){
        els.labelEl.textContent='Indexing complete';
        els.pctEl.textContent='100%';
        if(els.countEl)els.countEl.textContent=`${d.processed_files||0} / ${d.total_files||0} files`;
        setTimeout(()=>els.section.classList.remove('visible'),5000);
    }
    els.dot.className='status-dot green';
    document.getElementById('sb-status').textContent='Ready';

    if(els.gp.classList.contains('visible')){
        els.gp.classList.add('gp-done');
        els.gpFill.classList.remove('active');
        els.gpFill.style.width='100%';
        els.gpPct.textContent='100%';
        els.gpLabel.textContent=`Done -- ${d.processed_files||0} files indexed`;
        els.gpFile.textContent='';
        setTimeout(()=>{els.gp.classList.remove('visible','gp-done');},5000);
    }

    // Always refresh all page data after indexing completes
    fetchFileTree();
    fetchInsights();

    els.navDot.classList.remove('active');
    setTimeout(fetchStatus, 300);
    if(_evtSource){_evtSource.close();_evtSource=null;}
}

function updateProgress(d){
    if(d.scan_method){
        const label=d.scan_method==='ntfs_mft'?'MFT':'scandir';
        document.getElementById('s-scan').textContent=label;
        const dur=d.scan_duration_ms>0?` (${(d.scan_duration_ms/1000).toFixed(1)}s)`:'';
        document.getElementById('sb-scan').textContent='Scan: '+label+dur;
    }

    const els=_getProgressElements();
    if(d.status==='running'){
        _updateRunningState(d,els);
    }else{
        _updateCompleteState(d,els);
    }
}

/* â”€â”€ Fallback status fetch (used on boot & after SSE close) â”€â”€ */
async function fetchStatus(){
    try{
        const res=await fetch('/index/status');
        if(!res.ok)return;
        const d=await res.json();
        document.getElementById('s-files').textContent=d.files_indexed||0;
        document.getElementById('s-chunks').textContent=d.chunks_indexed||0;
        document.getElementById('sb-files').textContent='Files: '+(d.files_indexed||0);
        document.getElementById('sb-chunks').textContent='Chunks: '+(d.chunks_indexed||0);
        
        // Also update Insights page stats 
        if(document.getElementById('i-files')) {
            document.getElementById('i-files').textContent=d.files_indexed||0;
            document.getElementById('i-chunks').textContent=d.chunks_indexed||0;
        }

        if(d.scan_method){
            const label=d.scan_method==='ntfs_mft'?'MFT':'scandir';
            document.getElementById('s-scan').textContent=label;
            const dur=d.scan_duration_ms>0?` (${(d.scan_duration_ms/1000).toFixed(1)}s)`:'';
            document.getElementById('sb-scan').textContent='Scan: '+label+dur;
        } else {
            document.getElementById('s-scan').textContent='â€”';
            document.getElementById('sb-scan').textContent='Scan: â€”';
        }
        
        const dot=document.getElementById('status-dot');
        if(d.status==='running'){
            dot.className='status-dot amber';
            document.getElementById('sb-status').textContent='Indexing...';
            document.getElementById('nav-indexing-dot').classList.add('active');
            document.getElementById('global-progress').classList.add('visible');
            document.getElementById('global-progress').classList.remove('gp-done');
            document.getElementById('progress-section').classList.add('visible');
            startProgressStream();
        }else{
            dot.className='status-dot green';
            document.getElementById('sb-status').textContent='Ready';
            document.getElementById('nav-indexing-dot').classList.remove('active');
            document.getElementById('global-progress').classList.remove('visible');
        }
    }catch(err){console.debug('status fetch failed',err);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getHistory(){try{return JSON.parse(localStorage.getItem('pma-history')||'[]');}catch(err){console.debug('history parse error',err);return[];}}
function addHistory(q){
    let h=getHistory();
    h=h.filter(x=>x!==q);
    h.unshift(q);
    if(h.length>10)h=h.slice(0,10);
    localStorage.setItem('pma-history',JSON.stringify(h));
    renderHistory();
}
function renderHistory(){
    const c=document.getElementById('recent-tags');
    const h=getHistory();
    c.innerHTML='';
    if(!h.length){c.innerHTML='<span style="font-size:.75rem;color:var(--text-3)">No recent searches</span>';return;}
    h.slice(0,6).forEach(q=>{
        const tag=document.createElement('span');
        tag.className='recent-tag';
        tag.textContent=q;
        tag.title=q;
        tag.onclick=()=>{document.getElementById('search-input').value=q;askQuestion();};
        c.appendChild(tag);
    });
}

async function askQuestion(){
    const input=document.getElementById('search-input');
    const question=input.value.trim();
    if(!question)return;

    const btn=document.getElementById('ask-btn');
    btn.disabled=true;
    btn.textContent='Searchingâ€¦';
    document.getElementById('results-area').style.display='none';

    // Collect filter
    const filterEl=document.getElementById('filter-type');
    const file_type=filterEl?filterEl.value:null;
    const body={question};
    if(file_type)body.file_type=file_type;

    try{
        const res=await fetch('/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const data=await res.json();
        if(!res.ok){toast(data.error||'Search failed','error');return;}

        addHistory(question);

        document.getElementById('results-area').style.display='block';
        document.getElementById('answer-text').textContent=data.answer;

        // Latency badge
        const latBadge=document.getElementById('latency-badge');
        if(latBadge&&data.latency_ms!=null){
            latBadge.textContent=data.latency_ms.toFixed(0)+' ms';
            latBadge.style.display='inline-flex';
        }

        // Source count
        const srcCountEl=document.getElementById('source-count');
        if(srcCountEl)srcCountEl.textContent=(data.sources||[]).length?`(${(data.sources||[]).length})`:'(0)';

        const srcList=document.getElementById('sources-list');
        srcList.innerHTML='';
        (data.sources||[]).forEach((s,i)=>{
            const card=document.createElement('div');
            card.className='source-card';
            card.innerHTML=`
                <div class="source-num">${i+1}</div>
                <div class="source-body">
                    <div class="source-path">${escHtml(s.file_path)}</div>
                    <div class="source-text">${escHtml(s.text||'')}</div>
                    <div class="source-expand-hint">Click to expand</div>
                </div>
                <button class="source-copy" title="Copy path" data-path="${escHtml(s.file_path)}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                </button>`;
            // Copy handler
            card.querySelector('.source-copy').addEventListener('click',function(){navigator.clipboard.writeText(this.dataset.path);toast('Path copied','success');});
            // Expand / collapse source text on click
            const textEl=card.querySelector('.source-text');
            const hintEl=card.querySelector('.source-expand-hint');
            textEl.addEventListener('click',()=>{
                textEl.classList.toggle('expanded');
                hintEl.textContent=textEl.classList.contains('expanded')?'Click to collapse':'Click to expand';
            });
            srcList.appendChild(card);
        });
        if(!data.sources||!data.sources.length){
            srcList.innerHTML='<div class="empty-state"><p>No sources found</p></div>';
        }
    }catch(e){console.error('Search failed',e);toast('An error occurred','error');}
    finally{btn.disabled=false;btn.textContent='Ask Question';}
}

function escHtml(s){return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');}

// Enter to search
document.getElementById('search-input').addEventListener('keydown',e=>{
    if(e.key==='Enter'){e.preventDefault();askQuestion();}
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE TREE (EXPLORER)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _treeData=null;
async function fetchFileTree(){
    try{
        const res=await fetch('/files/tree');
        _treeData=await res.json();
        const fl = document.getElementById('explorer-filter');
        renderTree(_treeData, fl ? fl.value : '');
    }catch(err){console.debug('file tree fetch failed',err);}
}

function renderTree(data,filter=''){
    const summary=document.getElementById('explorer-summary');
    summary.textContent=`${data.total_files} files Â· ${fmt(data.total_size)} total`;

    const container=document.getElementById('file-tree');
    container.innerHTML='';
    const fl=filter.toLowerCase();

    for(const [folder,files] of Object.entries(data.folders||{})){
        const filtered=fl?files.filter(f=>f.path.toLowerCase().includes(fl)):files;
        if(fl&&!filtered.length)continue;

        const group=document.createElement('div');
        group.className='folder-group';

        const folderSize=filtered.reduce((s,f)=>s+f.size,0);
        const hdr=document.createElement('div');
        hdr.className='folder-hdr';
        hdr.innerHTML=`<span>ğŸ“ ${escHtml(folder)} <span style="color:var(--text-3);font-weight:400;font-size:.78rem">(${filtered.length})</span></span>
                       <span style="display:flex;align-items:center;gap:.5rem">
                         <span style="color:var(--text-3);font-weight:400;font-size:.78rem">${fmt(folderSize)}</span>
                         <span class="arrow">â–¶</span>
                       </span>`;

        const fileList=document.createElement('div');
        fileList.className='folder-files';
        const toggleFolder=()=>{fileList.classList.toggle('open');hdr.querySelector('.arrow').classList.toggle('open');};
        hdr.onclick=toggleFolder;
        hdr.setAttribute('role','button');
        hdr.setAttribute('tabindex','0');
        hdr.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleFolder();}};
        hdr.setAttribute('aria-expanded','false');
        hdr.addEventListener('click',()=>{hdr.setAttribute('aria-expanded',fileList.classList.contains('open'));});

        filtered.forEach(f=>{
            const name=f.path.split(/[/\\]/).pop();
            const row=document.createElement('div');
            row.className='file-row';
            row.innerHTML=`<span class="file-name"><span class="dot" style="background:${extColor(name)}"></span>${escHtml(name)}</span>
                           <span class="file-meta">${fmt(f.size)}</span>`;
            row.title=f.path;
            fileList.appendChild(row);
        });

        group.appendChild(hdr);
        group.appendChild(fileList);
        container.appendChild(group);
    }

    if(!Object.keys(data.folders||{}).length){
        container.innerHTML=`<div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
            <p>No files indexed yet</p>
            <small style="color:var(--text-3)">Head to the Library tab to add folders</small></div>`;
    }
}

function filterTree(val){
    if(_treeData)renderTree(_treeData,val);
}
let _filterTimer=null;
function debouncedFilterTree(val){
    clearTimeout(_filterTimer);
    _filterTimer=setTimeout(()=>filterTree(val),200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSIGHTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
globalThis._typeChart=null;
globalThis._folderChart=null;
globalThis._lastTypeData=null;
globalThis._lastFolderSizes=null;

async function fetchInsights(){
    try{
        const [insRes,statusRes,treeRes]=await Promise.all([
            fetch('/insights'),fetch('/index/status'),fetch('/files/tree')
        ]);
        const ins=await insRes.json();
        const status=await statusRes.json();
        const tree=await treeRes.json();

        document.getElementById('i-files').textContent=ins.file_count;
        document.getElementById('i-size').textContent=(ins.total_size_bytes/(1024*1024)).toFixed(1)+' MB';
        document.getElementById('i-chunks').textContent=status.chunks_indexed;
        document.getElementById('i-cold').textContent=(ins.cold_files||[]).length;

        // Type treemap
        globalThis._lastTypeData=ins.type_breakdown||{};
        renderTypeChart(globalThis._lastTypeData);

        // Folder treemap
        const folderSizes={};
        for(const [folder,files] of Object.entries(tree.folders||{})){
            folderSizes[folder]=files.reduce((s,f)=>s+f.size,0);
        }
        globalThis._lastFolderSizes=folderSizes;
        renderFolderChart(folderSizes);

        // Tables
        fillTable('top-files-body',ins.top_files||[]);
        fillTable('cold-files-body',ins.cold_files||[]);
    }catch(e){console.error('Insights load failed',e);toast('Failed to load insights','error');}
}

function fillTable(id,list){
    const tbody=document.getElementById(id);
    tbody.innerHTML='';
    if(!list.length){tbody.innerHTML='<tr><td colspan="2" style="text-align:center;color:var(--text-3)">No data</td></tr>';return;}
    list.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="table-path" title="${escHtml(f.path)}">${escHtml(f.path)}</td><td style="text-align:right">${fmt(f.size)}</td>`;
        tbody.appendChild(tr);
    });
}

/* â”€â”€ WinDirStat / TreeSize inspired color palette â”€â”€ */
const TYPE_COLORS={
    '.py':'#3572A5','.js':'#f0db4f','.ts':'#3178c6','.json':'#a4c639',
    '.md':'#083fa1','.txt':'#6b7280','.html':'#e34c26','.css':'#563d7c',
    '.pdf':'#e11d48','.java':'#b07219','.c':'#555555','.cpp':'#f34b7d',
    '.rs':'#dea584','.go':'#00add8','.rb':'#cc342d','.xml':'#0060ac',
    '.yaml':'#cb171e','.yml':'#cb171e','.sh':'#89e051','.bat':'#c1f12e',
    '.png':'#a36ad5','.jpg':'#a36ad5','.jpeg':'#a36ad5','.gif':'#a36ad5',
    '.svg':'#ff9900','.mp3':'#fb7d44','.mp4':'#fb7d44','.wav':'#fb7d44',
    '.zip':'#e6b800','.tar':'#e6b800','.gz':'#e6b800','.rar':'#e6b800',
    '.exe':'#9b59b6','.dll':'#9b59b6','.so':'#9b59b6',
    '.csv':'#2ecc71','.log':'#95a5a6','.ini':'#bdc3c7','.cfg':'#bdc3c7',
    '.sql':'#e38c00','.db':'#e38c00','.docx':'#2b579a','.xlsx':'#217346',
    '.pptx':'#d24726','.r':'#198ce7','.ipynb':'#f37626',
};
const FALLBACK_COLORS=['#3d15cb','#8e48ea','#e67e22','#27ae60','#e74c3c','#2980b9',
    '#8e44ad','#16a085','#d35400','#2c3e50','#f39c12','#1abc9c',
    '#c0392b','#7f8c8d','#6b2ff5','#b8a9e3'];
let _fallbackIdx=0;

function getTypeColor(ext){
    const key=ext.startsWith('.')?ext.toLowerCase():('.'+ext.toLowerCase());
    if(TYPE_COLORS[key])return TYPE_COLORS[key];
    // assign a stable fallback
    const color=FALLBACK_COLORS[_fallbackIdx%FALLBACK_COLORS.length];
    TYPE_COLORS[key]=color;
    _fallbackIdx++;
    return color;
}

const FOLDER_COLORS=['#3d15cb','#e67e22','#27ae60','#e74c3c','#2980b9','#8e44ad',
    '#16a085','#d35400','#f39c12','#1abc9c','#c0392b','#7f8c8d',
    '#8e48ea','#2ecc71','#e91e63','#00bcd4'];

function chartTextColor(){
    return document.documentElement.dataset.theme==='dark'?'#94a3b8':'#6b7280';
}
function chartGridColor(){
    return document.documentElement.dataset.theme==='dark'?'#1f2937':'#e5e7eb';
}
function isDark(){ return document.documentElement.dataset.theme==='dark'; }
function treemapBorder(){ return isDark()?'#0e0b1a':'#ffffff'; }

/* â”€â”€ contrast helper: pick white or black text based on bg luminance â”€â”€ */
function contrastText(hex){
    const c=hex.replace('#','');
    const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
    return (r*299+g*587+b*114)/1000>150?'#000000':'#ffffff';
}

/* â”€â”€ build external legend for a chart â”€â”€ */
function buildLegend(containerId, items){
    const el=document.getElementById(containerId);
    if(!el)return;
    el.innerHTML='';
    items.slice(0,10).forEach(({label,color})=>{
        const span=document.createElement('span');
        span.className='legend-item';
        span.innerHTML=`<span class="legend-dot" style="background:${color}"></span>${escHtml(label)}`;
        el.appendChild(span);
    });
}

function renderTypeChart(typeData){
    if(typeof Chart==='undefined'){console.warn('Chart.js not loaded');return;}
    const ctx=document.getElementById('type-chart');
    if(!ctx)return;
    if(globalThis._typeChart)globalThis._typeChart.destroy();
    const entries=Object.entries(typeData);
    if(!entries.length)return;

    const treeData=entries.map(([ext,d])=>({
        type:ext||'other',
        count:d.count||0,
        size:d.size||0
    })).filter(d=>d.size>0).sort((a,b)=>b.size-a.size);

    if(!treeData.length)return;
    const totalSize=treeData.reduce((s,d)=>s+d.size,0);

    // Lookup map: typeâ†’{count,size} (treemap plugin only aggregates the key field, not custom fields)
    const typeCountMap={};
    treeData.forEach(d=>{typeCountMap[d.type]={count:d.count,size:d.size};});

    // Build legend
    buildLegend('type-chart-legend', treeData.map(d=>({
        label:d.type+' ('+((d.size/totalSize)*100).toFixed(0)+'%)',
        color:getTypeColor(d.type)
    })));

    globalThis._typeChart=new Chart(ctx,{
        type:'treemap',
        data:{
            datasets:[{
                tree:treeData,
                key:'size',
                groups:['type'],
                spacing:1,
                borderWidth:2,
                borderColor:treemapBorder(),
                backgroundColor(c){
                    if(c.type!=='data')return 'transparent';
                    const d=c.raw&&c.raw._data;
                    if(!d)return FALLBACK_COLORS[c.dataIndex%FALLBACK_COLORS.length];
                    return getTypeColor(d.type||'other');
                },
                labels:{
                    display:true,
                    align:'left',
                    position:'top',
                    padding:4,
                    color(c){
                        if(c.type!=='data')return '#ffffff';
                        const d=c.raw&&c.raw._data;
                        if(!d)return '#ffffff';
                        return contrastText(getTypeColor(d.type||'other'));
                    },
                    font:[{size:13,weight:'bold'},{size:11}],
                    formatter(c){
                        if(!c||!c.raw)return '';
                        const d=c.raw._data;
                        if(!d)return '';
                        const typeName=d.type||c.raw.g||'';
                        if(!typeName)return '';
                        const info=typeCountMap[typeName]||{};
                        const w=c.raw.w||0, h=c.raw.h||0;
                        // Adaptive labels like WinDirStat/TreeSize:
                        // Only show text when rectangle is large enough
                        if(w<40||h<20)return '';
                        const sz=info.size||d.size||0;
                        const pct=totalSize>0?((sz/totalSize)*100).toFixed(1)+'%':'';
                        if(w<70||h<32)return typeName;
                        if(w<110||h<45)return [typeName, pct];
                        return [typeName, fmt(sz)+' Â· '+pct];
                    },
                    overflow:'hidden'
                },
                captions:{display:false}
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{display:false},
                tooltip:{
                    backgroundColor:isDark()?'#1a1530':'#ffffff',
                    titleColor:isDark()?'#f1f5e0':'#1a1530',
                    bodyColor:isDark()?'#b8b3cc':'#4a4560',
                    borderColor:isDark()?'#2a2542':'#d4d9c8',
                    borderWidth:1,
                    padding:10,
                    cornerRadius:8,
                    displayColors:true,
                    callbacks:{
                        title(items){
                            if(!items.length)return '';
                            const d=items[0].raw&&items[0].raw._data;
                            const typeName=d?(d.type||items[0].raw.g||'Unknown'):'Unknown';
                            return typeName;
                        },
                        label(item){
                            const d=item.raw&&item.raw._data;
                            if(!d)return '';
                            const typeName=d.type||item.raw.g||'';
                            const info=typeCountMap[typeName]||{};
                            const sz=info.size||d.size||0;
                            const cnt=info.count||0;
                            const pct=totalSize>0?((sz/totalSize)*100).toFixed(1)+'%':'';
                            return [' '+cnt+' files', ' '+fmt(sz)+' ('+pct+')'];
                        }
                    }
                }
            }
        }
    });
}

function renderFolderChart(folderSizes){
    if(typeof Chart==='undefined'){console.warn('Chart.js not loaded');return;}
    const ctx=document.getElementById('folder-chart');
    if(!ctx)return;
    if(globalThis._folderChart)globalThis._folderChart.destroy();
    const entries=Object.entries(folderSizes).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
    if(!entries.length)return;

    const treeData=entries.map(([k,v],i)=>{
        const parts=k.split(/[/\\]/);
        return {folder:parts[parts.length-1]||k, fullPath:k, size:v, _idx:i};
    });
    const totalSize=treeData.reduce((s,d)=>s+d.size,0);

    // Lookup map: folderâ†’{fullPath,size}
    const folderInfoMap={};
    treeData.forEach(d=>{folderInfoMap[d.folder]={fullPath:d.fullPath,size:d.size};});

    // Build legend
    buildLegend('folder-chart-legend', treeData.slice(0,10).map((d,i)=>({
        label:d.folder+' ('+((d.size/totalSize)*100).toFixed(0)+'%)',
        color:FOLDER_COLORS[i%FOLDER_COLORS.length]
    })));

    globalThis._folderChart=new Chart(ctx,{
        type:'treemap',
        data:{
            datasets:[{
                tree:treeData,
                key:'size',
                groups:['folder'],
                spacing:1,
                borderWidth:2,
                borderColor:treemapBorder(),
                backgroundColor(c){
                    if(c.type!=='data')return 'transparent';
                    return FOLDER_COLORS[c.dataIndex%FOLDER_COLORS.length];
                },
                labels:{
                    display:true,
                    align:'left',
                    position:'top',
                    padding:4,
                    color(c){
                        if(c.type!=='data')return '#ffffff';
                        return contrastText(FOLDER_COLORS[c.dataIndex%FOLDER_COLORS.length]);
                    },
                    font:[{size:13,weight:'bold'},{size:11}],
                    formatter(c){
                        if(!c||!c.raw)return '';
                        const d=c.raw._data;
                        if(!d)return '';
                        const folderName=d.folder||c.raw.g||'';
                        if(!folderName)return '';
                        const info=folderInfoMap[folderName]||{};
                        const w=c.raw.w||0, h=c.raw.h||0;
                        if(w<40||h<20)return '';
                        const sz=info.size||d.size||0;
                        const pct=totalSize>0?((sz/totalSize)*100).toFixed(1)+'%':'';
                        if(w<70||h<32)return folderName;
                        if(w<110||h<45)return [folderName, pct];
                        return [folderName, fmt(sz)+' Â· '+pct];
                    },
                    overflow:'hidden'
                },
                captions:{display:false}
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{display:false},
                tooltip:{
                    backgroundColor:isDark()?'#1a1530':'#ffffff',
                    titleColor:isDark()?'#f1f5e0':'#1a1530',
                    bodyColor:isDark()?'#b8b3cc':'#4a4560',
                    borderColor:isDark()?'#2a2542':'#d4d9c8',
                    borderWidth:1,
                    padding:10,
                    cornerRadius:8,
                    displayColors:true,
                    callbacks:{
                        title(items){
                            if(!items.length)return '';
                            const d=items[0].raw&&items[0].raw._data;
                            const folderName=d?(d.folder||items[0].raw.g||'Unknown'):'Unknown';
                            return folderName;
                        },
                        label(item){
                            const d=item.raw&&item.raw._data;
                            if(!d)return '';
                            const folderName=d.folder||item.raw.g||'';
                            const info=folderInfoMap[folderName]||{};
                            const sz=info.size||d.size||0;
                            const pct=totalSize>0?((sz/totalSize)*100).toFixed(1)+'%':'';
                            return [' Path: '+(info.fullPath||folderName), ' '+fmt(sz)+' ('+pct+')'];
                        }
                    }
                }
            }
        }
    });
}

function updateChartTheme(){
    // Full re-render for treemaps to pick up theme colors
    if(globalThis._lastTypeData)renderTypeChart(globalThis._lastTypeData);
    if(globalThis._lastFolderSizes)renderFolderChart(globalThis._lastFolderSizes);
}

/* â”€â”€ ResizeObserver: re-render charts when their containers resize â”€â”€ */
(function initChartResizeObservers(){
    const ro=new ResizeObserver(entries=>{
        for(const entry of entries){
            const canvas=entry.target.querySelector('canvas');
            if(!canvas)continue;
            const id=canvas.id;
            if(id==='type-chart'&&globalThis._typeChart){
                globalThis._typeChart.resize();
            }else if(id==='folder-chart'&&globalThis._folderChart){
                globalThis._folderChart.resize();
            }
        }
    });
    // Observe once DOM is ready
    document.querySelectorAll('.chart-wrap').forEach(w=>ro.observe(w));
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYSTEM INFO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchSystemInfo(){
    try{
        const res=await fetch('/system/info');
        const info=await res.json();
        const card=document.getElementById('sys-card');
        card.style.display='block';

        const badges=document.getElementById('sys-badges');
        badges.innerHTML='';
        const scanBadge=document.createElement('span');
        scanBadge.className='badge '+(info.is_admin?'green':'amber');
        scanBadge.textContent=info.is_admin?'âš¡ NTFS MFT (admin)':'ğŸ“‚ scandir mode';
        badges.appendChild(scanBadge);
        const osBadge=document.createElement('span');
        osBadge.className='badge blue';
        osBadge.textContent=info.os;
        badges.appendChild(osBadge);

        if(info.volumes&&info.volumes.length){
            const vg=document.getElementById('vol-grid');
            vg.innerHTML='';
            info.volumes.forEach(v=>{
                const pct=((v.used_gb/v.total_gb)*100);
                let color='var(--success)';
                if(pct>90)color='var(--danger)';
                else if(pct>75)color='var(--warn)';
                const card=document.createElement('div');
                card.className='vol-card';
                card.innerHTML=`<div class="vol-letter">${v.letter}</div>
                    <div class="vol-bar"><div class="vol-fill" style="width:${pct.toFixed(0)}%;background:${color}"></div></div>
                    <div>${v.free_gb} GB free / ${v.total_gb} GB</div>`;
                vg.appendChild(card);
            });
        }
    }catch(err){console.debug('system info not available',err);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMMAND PALETTE (Ctrl+K)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openCmdPalette(){
    const dialog=document.getElementById('cmd-overlay');
    if(!dialog.open)dialog.showModal();
    const inp=document.getElementById('cmd-input');
    inp.value='';
    inp.focus();
}
function closeCmdPalette(ev){
    if(ev&&ev.target!==document.getElementById('cmd-overlay'))return;
    const dialog=document.getElementById('cmd-overlay');
    if(dialog.open)dialog.close();
}
function runCmdSearch(){
    const q=document.getElementById('cmd-input').value.trim();
    if(!q)return;
    const dlg=document.getElementById('cmd-overlay');if(dlg.open)dlg.close();
    document.getElementById('search-input').value=q;
    switchPage('search');
    askQuestion();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
    // Ctrl+K â†’ Command palette
    if((e.ctrlKey||e.metaKey)&&e.key==='k'){
        e.preventDefault();
        openCmdPalette();
    }
    // Escape â†’ close palette
    if(e.key==='Escape'){
        closeCmdPalette();
    }
});

const cmdOverlay=document.getElementById('cmd-overlay');
cmdOverlay.addEventListener('click',e=>closeCmdPalette(e));
cmdOverlay.addEventListener('keydown',e=>{if(e.key==='Escape')closeCmdPalette();});

Object.assign(globalThis,{
    switchPage,
    toggleTheme,
    pickFolder,
    pickFiles,
    startIndexing,
    seedDemo,
    cleanupStale,
    exportIndex,
    clearDatabase,
    askQuestion,
    fetchFileTree,
    closeCmdPalette,
    runCmdSearch
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
renderHistory();
await fetchSystemInfo();
await fetchStatus();

// Auto-refresh: poll status every 5s so pages stay current
setInterval(async()=>{
    try{
        const res=await fetch('/index/status');
        if(!res.ok)return;
        const d=await res.json();
        // Update Library page counters
        document.getElementById('s-files').textContent=d.files_indexed||0;
        document.getElementById('s-chunks').textContent=d.chunks_indexed||0;
        document.getElementById('sb-files').textContent='Files: '+(d.files_indexed||0);
        document.getElementById('sb-chunks').textContent='Chunks: '+(d.chunks_indexed||0);
    }catch(e){/* silent */}
},5000);
</script>
</body>
</html>
